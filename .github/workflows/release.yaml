name: Release

run-name: Release ${{ inputs.package }}

on:
  push:
    tags:
      - '@*/*/v*'
      - '*/v*'

permissions:
  actions: read
  contents: read

jobs:
  extract-package-info:
    runs-on: ubuntu-latest
    outputs:
      package-name: ${{ steps.extract.outputs.package-name }}
      package-version: ${{ steps.extract.outputs.package-version }}
    steps:
      - name: Extract package info from git tag
        id: extract
        uses: ./actions/package-extractor
        with:
          git-tag: ${{ github.ref_name }}

  main:
    needs: extract-package-info
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          filter: tree:0
          fetch-depth: 0

      # Cache node_modules
      - name: Setup Node.js and install dependencies
        uses: ./actions/setup-node-cicd
        with:
          registry-url: ${{ secrets.PRIVATE_NPM_REGISTRY }}
          node-auth-token: ${{ secrets.PRIVATE_NPM_REGISTRY_TOKEN }}

      - name: Write package info to summary
        run: |
          echo "## ðŸ“¦ Release Information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Package Name | \`${{ needs.extract-package-info.outputs.package-name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Package Version | \`${{ needs.extract-package-info.outputs.package-version }}\` |" >> $GITHUB_STEP_SUMMARY

      - name: Validate Changes
        run: npx nx run-many -t lint test build typecheck --project=${{needs.extract-package-info.outputs.package-name}}

      - name: Publish to NPM
        run: |
          npm publish -w ${{needs.extract-package-info.outputs.package-name}}

      - name: Extract Changelog
        id: extract-changelog
        uses: ./actions/release-changelog
        with:
          package-path: ${{needs.extract-package-info.outputs.package-name}}
      

      - name: Create Release
        id: create-Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          release_name: ${{ github.ref_name }}
          body: |
            ## Release: ${{ github.ref_name }}

            ## Changes
            ${{ steps.extract-changelog.outputs.changelog-text }}
